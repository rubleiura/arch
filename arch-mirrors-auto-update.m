
#
# Инструкция: Автоматическое обновление зеркал Arch Linux с использованием rate-mirrors
# Версия: 1.0
# Автор: rublev (на основе системных предпочтений пользователя)
# Цель: Настроить безопасное, автоматическое обновление /etc/pacman.d/mirrorlist
#       без конфликтов, с логированием и поддержкой ограничения rate-mirrors на запуск от root.
#
# Примечание: Эта инструкция НЕ является автоматическим установочным скриптом.
#             Выполняйте команды построчно в терминале или копируйте блоки вручную.
#             Все действия требуют прав sudo.

# ==============================================================================
# ШАГ 1: Установка необходимого пакета rate-mirrors-bin
# ==============================================================================

# Устанавливаем современный инструмент для тестирования скорости зеркал.
# Он НЕ допускает запуск от root — это важно учитывать при настройке.
yay -S rate-mirrors-bin --needed

# Проверка: убедитесь, что ваш пользователь существует и имеет UID 1000
# (стандартный первый пользователь в Arch Linux, например, 'rublev')
id 1000

# ==============================================================================
# ШАГ 2: Создание безопасного скрипта обновления зеркал
# ==============================================================================

# Скрипт будет:
#   - определять пользователя с UID 1000 (обычно ваш основной аккаунт),
#   - запускать rate-mirrors от этого пользователя (без прав root),
#   - записывать результат в mirrorlist с правами root,
#   - вести лог в /var/log/mirror-update.log.

sudo tee /usr/local/bin/update-mirrors.sh > /dev/null <<'EOF'
#!/bin/sh
# Строгий режим: выход при ошибке или неопределённой переменной
set -eu

# Определяем имя пользователя с UID 1000 (первый обычный пользователь)
TARGET_USER=$(getent passwd 1000 | cut -d: -f1)

# Проверка: пользователь найден?
if [ -z "$TARGET_USER" ]; then
    echo "[$(date)] Ошибка: не найден пользователь с UID 1000." >&2
    exit 1
fi

# Защита: убедимся, что это не root
if [ "$TARGET_USER" = "root" ]; then
    echo "[$(date)] Ошибка: пользователь с UID 1000 — root. Недопустимо." >&2
    exit 1
fi

# Создаём временный файл для безопасной записи
TMPFILE=$(mktemp)

# Запускаем rate-mirrors от обычного пользователя (обход ограничения root)
if sudo -u "$TARGET_USER" rate-mirrors --protocol https --max-mirrors-to-output 20 arch > "$TMPFILE"; then
    # Проверяем, что результат содержит хотя бы одно зеркало
    if [ -s "$TMPFILE" ] && grep -q '^Server' "$TMPFILE"; then
        # Безопасно заменяем системный mirrorlist
        install -m 644 "$TMPFILE" /etc/pacman.d/mirrorlist
        echo "[$(date)] Зеркала успешно обновлены (пользователь: $TARGET_USER)." >> /var/log/mirror-update.log
    else
        echo "[$(date)] Ошибка: rate-mirrors вернул пустой или некорректный результат." >> /var/log/mirror-update.log
    fi
else
    echo "[$(date)] Ошибка: rate-mirrors завершился с кодом ≠ 0." >> /var/log/mirror-update.log
fi

# Удаляем временный файл
rm -f "$TMPFILE"
EOF

# Назначаем права на выполнение
sudo chmod +x /usr/local/bin/update-mirrors.sh

# ==============================================================================
# ШАГ 3: Создание systemd-сервиса
# ==============================================================================

# Сервис вызывает наш скрипт один раз при активации таймером.
sudo tee /etc/systemd/system/update-mirrors.service > /dev/null <<'EOF'
[Unit]
Description=Update Arch Linux mirrorlist
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/update-mirrors.sh
StandardOutput=journal
StandardError=journal
EOF

# ==============================================================================
# ШАГ 4: Создание systemd-таймера (ежедневное обновление)
# ==============================================================================

# Таймер будет запускать обновление каждый день в случайное время
# (с задержкой до 5 минут), чтобы избежать пиковой нагрузки на зеркала.
sudo tee /etc/systemd/system/update-mirrors.timer > /dev/null <<'EOF'
[Unit]
Description=Daily mirrorlist update
Requires=update-mirrors.service

[Timer]
OnCalendar=daily
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target
EOF

# ==============================================================================
# ШАГ 5: Отключение конфликтующего reflector.timer (если активен)
# ==============================================================================

# Пакет reflector поставляется со своим таймером, который может перезаписать
# ваш mirrorlist. Отключаем его, чтобы избежать конфликтов.
sudo systemctl disable --now reflector.timer reflector.service 2>/dev/null || true

# (Опционально) Удалить пакет reflector, если он не используется
# sudo pacman -R reflector

# ==============================================================================
# ШАГ 6: Активация и проверка
# ==============================================================================

# Перезагружаем конфигурацию systemd
sudo systemctl daemon-reexec

# Включаем и запускаем наш таймер
sudo systemctl enable --now update-mirrors.timer

# Проверка: таймер запланирован?
systemctl list-timers update-mirrors.timer

# Проверка: попробуйте обновить зеркала вручную
sudo /usr/local/bin/update-mirrors.sh

# Просмотр последнего результата
journalctl -u update-mirrors.service -n 10 --no-pager

# Просмотр лога (если файл существует)
sudo cat /var/log/mirror-update.log 2>/dev/null || echo "Лог пока пуст."

# ==============================================================================
# ГОТОВО!
# ==============================================================================
#
# Теперь ваш список зеркал:
#   - обновляется автоматически раз в сутки,
#   - использует только HTTPS,
#   - выбирает самые быстрые зеркала для вашего региона (без привязки к стране),
#   - защищён от повреждения при ошибках,
#   - не конфликтует с другими менеджерами зеркал.
#
# Для ручного обновления в любой момент выполните:
#   sudo /usr/local/bin/update-mirrors.sh
#
# Файл можно сохранить как arch-mirrors-auto-update.txt или .sh для справки.
