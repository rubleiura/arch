#
# ==============================================================================
# Инструкция: Настройка пароля и уникального имени суперпользователя для GRUB
# Совместимо с Arch Linux + UEFI + BTRFS + LUKS + snapper + grub-btrfs
# Повышает безопасность за счёт скрытого имени пользователя (не "root")
# Выполнять ВРУЧНУЮ, по шагам, в терминале.
# Автор: forename
# Дата: 2026-01-06
# ==============================================================================

# ----------------------------------------------------------------------------
# ШАГ 1: Выберите УНИКАЛЬНОЕ имя суперпользователя GRUB
# ----------------------------------------------------------------------------
# Это имя НЕ связано с вашими учётными записями в Linux.
# Оно существует ТОЛЬКО в контексте GRUB.
# Рекомендуется использовать непредсказуемое имя (не "admin", не "root").
# Примеры: bootguard, vaultkeeper, syslock, grubmaster2026
#
# ЗАПОМНИТЕ или ЗАПИШИТЕ это имя — оно понадобится на Шаге 3.
#
# В этой инструкции мы будем использовать: "bootguard"
# Вы можете заменить его на своё.

# ----------------------------------------------------------------------------
# ШАГ 2: Генерация PBKDF2-хеша пароля
# ----------------------------------------------------------------------------
# Эта команда запросит пароль дважды и выведет хеш.
# ВНИМАНИЕ: пароль не отображается при вводе — это нормально.
# КОПИРУЙТЕ только строку, начинающуюся с "grub.pbkdf2.sha512..."

sudo grub-mkpasswd-pbkdf2

# ----------------------------------------------------------------------------
# ШАГ 3: Редактирование файла /etc/grub.d/40_custom
# ----------------------------------------------------------------------------
# Открываем файл в редакторе nano.
# Прокрутите в самый конец файла.

sudo nano /etc/grub.d/40_custom

# В КОНЦЕ ФАЙЛА добавьте ТОЧНО ЭТИ ДВЕ СТРОКИ:

set superusers="bootguard"
password_pbkdf2 bootguard grub.pbkdf2.sha512.10000.ВАШ_ХЕШ_ЗДЕСЬ

# Правила:
# - Замените "bootguard" на ВАШЕ выбранное имя (должно совпадать в обеих строках).
# - Замените "ВАШ_ХЕШ_ЗДЕСЬ" на хеш из Шага 2.
# - Не ставьте кавычки вокруг хеша.
# - Не добавляйте пробелы в начале строк.
# - Не удаляйте существующие строки в файле.
#
# После добавления:
#   - Сохранить:    Ctrl+O → Enter
#   - Выйти:        Ctrl+X

# ----------------------------------------------------------------------------
# ШАГ 4: Обновление конфигурации GRUB
# ----------------------------------------------------------------------------
# Эта команда пересоберёт grub.cfg с учётом нового имени и пароля.
# Убедитесь, что в выводе есть "Found snapshot ..." — значит, snapper работает.

sudo grub-mkconfig -o /boot/grub/grub.cfg

# ----------------------------------------------------------------------------
# ШАГ 5: Проверка (опционально)
# ----------------------------------------------------------------------------
# Убедитесь, что имя и хеш записаны корректно.

tail -n 3 /etc/grub.d/40_custom

# Ожидаемый вывод (с вашим именем и хешем):
#
# set superusers="bootguard"
# password_pbkdf2 bootguard grub.pbkdf2.sha512.10000.ВАШ_ХЕШ...

# ----------------------------------------------------------------------------
# ГОТОВО.
# ----------------------------------------------------------------------------
# Поведение после перезагрузки:
# - Автоматическая загрузка: БЕЗ пароля.
# - Выбор снапшота: БЕЗ пароля.
# - Нажатие "e" или "c" в GRUB: ТРЕБУЕТ пароль + имя.
#   → GRUB запросит: "Username:" и "Password:"
#   → Введите: bootguard + ваш пароль
#
# Это защищает от:
# - Угадывания известного имени ("root")
# - Автоматизированных атак на GRUB
# - Обхода LUKS через init=/bin/bash
# ==============================================================================
