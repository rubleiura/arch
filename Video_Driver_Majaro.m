################################################################
# ПОЛНОЕ РУКОВОДСТВО ПО УСТАНОВКЕ ВИДЕОДРАЙВЕРОВ В MANJARO LINUX
# Версия: 3.1 (Script-Style)
# Формат: Текстовый файл для копирования команд
################################################################

# ВНИМАНИЕ: Этот файл НЕ является скриптом для автоматического запуска.
# Копируйте команды по одной строке и вставляйте в терминал.
# Все строки, начинающиеся с #, являются комментариями.
# Все строки без # являются командами для выполнения.

################################################################
# 1. ПОДГОТОВКА СИСТЕМЫ И СНАПШОТЫ
################################################################

# Обновление зеркал и системы
sudo pacman-mirrors --fasttrack
sudo pacman -Syu

# Установка заголовков ядра (необходимо для драйверов Nvidia)
# Команда автоматически определит версию ядра (например, linux66-headers)
sudo pacman -S linux$(uname -r | cut -d '.' -f 1,2)-headers

# ВАЖНО: Перед созданием снапшота откройте Timeshift в меню и выберите тип "Btrfs".
# Если выбран RSYNC, снапшот будет создаваться долго.
sudo timeshift --create --comments "Before GPU drivers setup"

# Если включен Secure Boot в BIOS, рекомендуется отключить его перед установкой Nvidia.

################################################################
# 2. УСТАНОВКА ДРАЙВЕРОВ (MHWD)
################################################################

# Выберите ТОЛЬКО ОДНУ команду в зависимости от вашей видеокарты:

# Вариант А: Intel или AMD (Встроенная или дискретная AMD)
sudo mhwd -a pci free 0300

# Вариант Б: Nvidia (Десктоп или ноутбук без гибрида)
sudo mhwd -a pci nonfree 0300

# Вариант В: Гибридная графика (Intel/AMD + Nvidia)
sudo mhwd -a pci nonfree 0300

# Установка утилит для гибридной графики (для Варианта В)
sudo pacman -S nvidia-prime switcheroo-control

################################################################
# 3. НАСТРОЙКА MKINITCPIO (EARLY KMS)
################################################################

# Отредактируйте файл конфигурации initramfs
sudo nano /etc/mkinitcpio.conf

# В ОТКРЫТОМ ФАЙЛЕ найдите строку MODULES= и измените её:
# Для Intel: MODULES=(i915)
# Для AMD: MODULES=(amdgpu)
# Для Nvidia (Десктоп): MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)
# Для Гибрида (Важно!): MODULES=(i915 nvidia_drm) или (amdgpu nvidia_drm)
# Не добавляйте все модули Nvidia в гибридном режиме, это вызовет черный экран.

# Найдите строку HOOKS= и убедитесь, что порядок такой:
# HOOKS=(base udev autodetect modconf block btrfs resume filesystems keyboard fsck)
# 'resume' должен стоять перед 'filesystems'. Хук 'kms' можно удалить.

# Сохраните файл (Ctrl+O, Enter) и выйдите (Ctrl+X).

# Примените изменения конфигурации
sudo mkinitcpio -P

################################################################
# 4. НАСТРОЙКА ГИБЕРНАЦИИ (GRUB И SWAP)
################################################################

# ВАРИАНТ 4.1: Если у вас отдельный SWAP-РАЗДЕЛ
# Узнайте UUID раздела подкачки
blkid | grep swap

# Отредактируйте GRUB
sudo nano /etc/default/grub

# В строке GRUB_CMDLINE_LINUX_DEFAULT добавьте:
# resume=UUID=ваш-uuid-свопа nvidia-drm.modeset=1

# ВАРИАНТ 4.2: Если у вас SWAP-ФАЙЛ на Btrfs
# Узнайте UUID раздела (где лежит файл swapfile)
blkid

# Рассчитайте offset файла (Команда исправлена для новых версий btrfs-progs)
sudo filefrag -v /swap/swapfile | awk '{if($1=="0:"){print $4}}' | cut -d ':' -f 1
# Запомните полученное число (это offset)

# Отредактируйте GRUB
sudo nano /etc/default/grub

# В строке GRUB_CMDLINE_LINUX_DEFAULT добавьте:
# resume=UUID=uuid-раздела resume_offset=число-offset nvidia-drm.modeset=1

# Сохраните файл (Ctrl+O, Enter) и выйдите (Ctrl+X).

# Обновите конфигурацию загрузчика
sudo update-grub

################################################################
# 5. НАСТРОЙКА ОТОБРАЖЕНИЯ (WAYLAND / X11)
################################################################

# ВАРИАНТ 5.1: Wayland (Для Nvidia драйверов < 555 версии)
sudo nano /etc/environment

# Добавьте строки (для драйверов 555+ это обычно не требуется):
# __GLX_VENDOR_LIBRARY_NAME=nvidia
# GBM_BACKEND=nvidia-drm
# Если курсор невидимый, добавьте: WLR_NO_HARDWARE_CURSORS=1

# Сохраните файл (Ctrl+O, Enter) и выйдите (Ctrl+X).

# ВАРИАНТ 5.2: X11 (Устранение разрывов изображения)
sudo nano /etc/X11/xorg.conf.d/20-gpu.conf

# Вставьте следующий контент (для Intel используйте modesetting, НЕ intel):
# Section "Device"
#     Identifier "GPU"
#     Driver "modesetting"
#     Option "TearFree" "true"
# EndSection

# Для AMD используйте Driver "amdgpu".

# Сохраните файл (Ctrl+O, Enter) и выйдите (Ctrl+X).

################################################################
# 6. ГИБРИДНАЯ ГРАФИКА И ЭНЕРГОСБЕРЕЖЕНИЕ
################################################################

# Включите сервис переключения графики (нужно для меню "Запустить на...")
sudo systemctl enable --now switcheroo-control

# Проверьте доступные видеокарты (должно показать integrated и discrete)
switcheroo-control --list

# (Рекомендуется для ноутбуков Nvidia) Установка управления питанием
sudo pacman -S nvidia-powerd
sudo systemctl enable --now nvidia-powerd

# Пример запуска приложения на дискретной карте (ID обычно 1)
# switcheroo-control launch --gpu 1 steam
# prime-run steam (альтернативный способ для Nvidia)

################################################################
# 7. ПРОВЕРКА РЕЗУЛЬТАТОВ (ПОСЛЕ ПЕРЕЗАГРУЗКИ)
################################################################

# Перезагрузите систему перед проверкой
# reboot

# Установите утилиты для диагностики
sudo pacman -S mesa-utils vulkan-tools libva-utils glmark2

# Проверка установленных драйверов MHWD
mhwd -li

# Проверка статуса Nvidia (если есть)
nvidia-smi

# Проверка OpenGL рендерера
glxinfo | grep OpenGL

# Проверка поддержки Vulkan (важно для игр)
vulkaninfo --summary

# Проверка аппаратного декодирования видео
vainfo

# Проверка переключения GPU (должен показать дискретную карту)
switcheroo-control launch --gpu 1 glxinfo | grep 'OpenGL renderer string'

# Тест производительности
glmark2
vkcube

################################################################
# КОНЕЦ РУКОВОДСТВА
################################################################