##############################################################
### ОБНОВЛЕННОЕ РУКОВОДСТВО ПО УСТАНОВКЕ ГРАФИЧЕСКИХ ДРАЙВЕРОВ
### (С акцентом на Wayland, гибернацию и современные практики - 2025)
### + Визуальные тесты (включая glmark2)
### + Использование switcherooctl
### + Дополнительные настройки (включая TLP для ноутбуков)



##############################################################
# ВАЖНО:
# 1. Это РУКОВОДСТВО продолжение БЛОКА 12 из основного макета.
# 2. Выполняйте команды ИЗ ЭТОГО ФАЙЛА согласно вашей видеокарте.
# 3. КОПИРУЙТЕ и ВСТАВЛЯЙТЕ команды вручную.
# 4. После перезагрузки в новой системе выполните проверки.
# 5. Для NVIDIA (проприетарные и nouveau) обязательно выполните проверку после перезагрузки!




##############################################################

# 0. ПОДГОТОВКА И ОПРЕДЕЛЕНИЕ ВИДЕОКАРТЫ
# В Live-среде или в установленной системе выполните:

lspci | grep -e VGA -e 3D -e Display

# или

inxi -G

# Запишите производителя (Intel, AMD, NVIDIA) и модель (для NVIDIA: уточните поколение - например, Fermi, Kepler, Maxwell, Pascal и т.д.).
# Проверьте совместимость вашей модели NVIDIA на официальном сайте NVIDIA (https://www.nvidia.com/drivers/).

# 1. ВЫБОР ВАРИАНТА УСТАНОВКИ
# Ниже приведены 4 варианта. Выберите ОДИН, соответствующий вашей конфигурации.
# ВАЖНО: Все команды в блоках ниже закомментированы символом '#'. ПЕРЕД ВСТАВКОЙ В ТЕРМИНАЛ,
# УБЕРИТЕ СИМВОЛ '#' И ПРОБЕЛ в НАЧАЛЕ СТРОКИ для ТЕХ КОМАНД, которые соответствуют
# вашей конфигурации (тип GPU, наличие гибридной графики, желание использовать опциональные настройки).






##############################################################
### ВАРИАНТ 1: Intel Integrated Graphics (Только Intel)
##############################################################

# БАЗОВАЯ УСТАНОВКА:

# pacman -S --noconfirm mesa vulkan-intel
# pacman -S --noconfirm lib32-mesa lib32-vulkan-intel







##############################################################
### ВАРИАНТ 2: AMD Radeon Graphics (Только AMD)
##############################################################

# БАЗОВАЯ УСТАНОВКА:

# pacman -S --noconfirm mesa vulkan-radeon
# pacman -S --noconfirm lib32-mesa lib32-vulkan-radeon







##############################################################
### ВАРИАНТ 3: NVIDIA Graphics (Проприетарные драйверы)
### Подходит для современных карт (Pascal, Turing, Ampere, Ada Lovelace и новее).
##############################################################


# ШАГ 1: ВЫБЕРИТЕ ДРАЙВЕР. Установите ТОЛЬКО ОДИН:


# A. Для стандартного ядра (linux):

# pacman -S --noconfirm nvidia nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia


# B. Для LTS-ядра (linux-lts):

# pacman -S --noconfirm nvidia-lts nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia


# C. Универсальный DKMS-драйвер (если стандартный не подходит или кастомное ядро):

# pacman -S --noconfirm nvidia-dkms nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia

##############################################################

# ШАГ 2: ДОПОЛНИТЕЛЬНО (только для гибридной графики Intel/AMD + NVIDIA:

# pacman -S --noconfirm switcheroo-control # Устанавливаем пакет (клиент и сервис)
# systemctl enable switcheroo-control.service # Включаем сервис

##############################################################

# ШАГ 3: КОНФИГУРАЦИЯ СИСТЕМЫ:

# Создание файла настройки модуля:

# echo 'options nvidia-drm modeset=1' > /etc/modprobe.d/nvidia.conf
# echo 'options nvidia NVreg_DynamicPowerManagement=0x02' >> /etc/modprobe.d/nvidia.conf # Для ноутбуков (опционально)






##############################################################

### ИНСТРУМЕНТ ДЛЯ СВЯЗИ МЕЖДУ ПРИЛОЖЕНИЯМИ И АППАРАТНЫМ ОБЕСПЕЧЕНИЕМ:
### Необходим для всех видеокарт

# pacman -S --noconfirm vulkan-icd-loader lib32-vulkan-icd-loader






##############################################################

# ФИНАЛЬНАЯ СБОРКА).

# Выполните команды, как в других вариантах:

grub-mkconfig -o /boot/grub/grub.cfg
mkinitcpio -P






##############################################################


# 5. ОПЦИОНАЛЬНЫЕ НАСТРОЙКИ ДЛЯ НОУТБУКОВ

# Управление питанием (TLP - популярный выбор):

# pacman -S --noconfirm tlp tlp-rdw
# systemctl enable tlp.service
# systemctl mask systemd-rfkill.service systemd-rfkill.socket







##############################################################

# 2. ВАЖНО: ВОЗВРАТ К ОСНОВНОМУ МАКЕТУ

# 1. Убедитесь, что все шаги из руководства выполнены.
# 2. НЕ ВЫХОДИТЕ из chroot.
# 3. ВЕРНИТЕСЬ к основному макету.
# 5. Продолжайте выполнение основного макета





##############################################################

# 6. ПРОВЕРКА РАБОТЫ ВИДЕОКАРТ ПОСЛЕ ПЕРЕЗАГРУЗКИ

# ВЫПОЛНИТЕ ЭТИ КОМАНДЫ ТОЛЬКО ПОСЛЕ ПЕРЕЗАГРУЗКИ В НОВУЮ СИСТЕМУ И ВХОДА КАК ПОЛЬЗОВАТЕЛЬ!
# Убедитесь, что пакеты для проверки установлены (они входят в основной макет или должны быть установлены дополнительно).

# Проверка драйвера NVIDIA (только для проприетарных драйверов):

nvidia-smi

# Проверка Vulkan (для всех):

vulkaninfo --summary

# Проверка VA-API (для всех):

# pacman -S libva-utils

vainfo

# Проверка switcherooctl (для гибридной графики):

switcherooctl list # Проверяем, видит ли утилита обе карты

# Запускаем glxinfo через switcherooctl на GPU 1 (NVIDIA - проприетарный или nouveau)

switcherooctl launch --gpu 1 glxinfo | grep 'OpenGL renderer string'

# ВИЗУАЛЬНЫЕ ТЕСТЫ
# более сложный OpenGL бенчмарк

# pacman -S --noconfirm mesa-utils vulkan-tools glmark2 mesa-demos

glmark2

# 1. Откройте терминал в графической оболочке.
# 2. Выполните команды для проверки:

glxgears # (должны вращаться шестерёнки)


vkcube # (должен вращаться 3D куб)

glmark2 # (запустит бенчмарк OpenGL)

glxinfo | grep 'renderer string' # (проверка драйвера)

# Для NVIDIA с switcherooctl:

switcherooctl launch --gpu 1 glmark2

# Для NVIDIA с legacy Prime (устаревшее, для Xorg):

DRI_PRIME=1 glmark2







##############################################################

# 7. ИСПОЛЬЗОВАНИЕ switcherooctl (после установки системы и входа в сеанс пользователя)

# После перезагрузки и входа в систему, вы можете использовать switcherooctl для запуска приложений на определённой видеокарте в Wayland.

# А. Определение ID видеокарты:

# Перед запуском приложения узнайте ID интересующей вас видеокарты.

switcherooctl list

# В выводе будет список устройств (Device: 0, Device: 1 и т.д.). Найдите вашу дискретную карту (например, NVIDIA) и запомните её номер (Device: X).
# В примере выше, NVIDIA - это Device: 1.

# Б. Запуск приложения на определённой видеокарте:

# Используйте команду switcherooctl launch --gpu <ID> <команда>.

# Примеры:

# Запуск игры (например, steam) на дискретной GPU (предположим, ID = 1):

# switcherooctl launch --gpu 1 steam

# Запуск glxinfo для проверки OpenGL рендера:

switcherooctl launch --gpu 1 glxinfo | grep "OpenGL renderer string"

# Запуск vkcube для проверки Vulkan:

switcherooctl launch --gpu 1 vkcube

# Запуск бенчмарка:

switcherooctl launch --gpu 1 glmark2


##############################################################




