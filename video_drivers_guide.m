##############################################################
# ### ОБНОВЛЕННОЕ РУКОВОДСТВО ПО УСТАНОВКЕ ГРАФИЧЕСКИХ ДРАЙВЕРОВ
# ### (С акцентом на гибернацию и современные практики - 2025)
# ### + Визуальные тесты (включая glmark2)
# ### + Использование switcherooctl
# ### + Дополнительные настройки (включая TLP для ноутбуков)
# ##############################################################
# ВАЖНО:
# 1. Это РУКОВОДСТВО используется ВМЕСТО БЛОКА 12 из основного макета.
# 2. Выполняйте команды ИЗ ЭТОГО ФАЙЛА (в chroot или после) согласно вашей видеокарте.
# 3. КОПИРУЙТЕ и ВСТАВЛЯЙТЕ команды вручную в сессию chroot.
# 4. После перезагрузки в новой системе выполните проверки.
# 5. Для NVIDIA (проприетарные и nouveau) обязательно выполните проверку после перезагрузки!
# 6. Эта инструкция избегает настроек, ломающих гибернацию.
# 7. Инструкция учитывает использование Wayland и современные методы offloading (switcherooctl).
# 8. ПРОЧИТАЙТЕ ВЕСЬ ФАЙЛ ПЕРЕД НАЧАЛОМ!
# 9. Разделы с визуальными тестами, использованием switcherooctl и *дополнительными настройками* (включая TLP для ноутбуков) находятся В КОНЦЕ этого файла.
# ##############################################################

# 0. ПОДГОТОВКА И ОПРЕДЕЛЕНИЕ ВИДЕОКАРТЫ
# В Live-среде или в установленной системе выполните:
# lspci | grep -e VGA -e 3D -e Display
# или
# inxi -G
# Запишите производителя (Intel, AMD, NVIDIA) и модель (для NVIDIA: уточните поколение - например, Fermi, Kepler, Maxwell, Pascal и т.д.).

# 1. ВЫБОР ВАРИАНТА УСТАНОВКИ
# Ниже приведены 4 варианта. Выберите ОДИН, соответствующий вашей конфигурации.
# КОПИРУЙТЕ команды ИЗ нужного варианта и ВСТАВЬТЕ ИХ в chroot-сессию (после arch-chroot /mnt /bin/bash).
# НЕ ЗАПУСКАЙТЕ ЭТОТ ФАЙЛ КАК СКРИПТ.
# ПЕРЕД ВЫПОЛНЕНИЕМ УБЕДИТЕСЬ, ЧТО ВЫ ВНУТРИ CHROOT.
# ВАЖНО: Все команды в блоках ниже закомментированы символом '#'. ПЕРЕД ВСТАВКОЙ В ТЕРМИНАЛ,
# УБЕРИТЕ СИМВОЛ '#' И ПРОБЕЛ в НАЧАЛЕ СТРОКИ для ТЕХ КОМАНД, которые соответствуют
# вашей конфигурации (тип GPU, наличие гибридной графики, желание использовать опциональные настройки).

##############################################################
### ВАРИАНТ 1: Intel Integrated Graphics (Только Intel)
##############################################################
# БАЗОВАЯ УСТАНОВКА:
# pacman -S --noconfirm vulkan-intel intel-media-driver libva-intel-driver
# pacman -S --noconfirm lib32-vulkan-intel lib32-mesa

# Опционально: Для новых GPU (Gen12+/Alchemist/Xe)
# pacman -S --noconfirm onevpl-intel-gpu intel-compute-runtime

# ОПЦИОНАЛЬНЫЕ НАСТРОЙКИ (в chroot или после):
# А. Для новейших GPU (если есть проблемы со стабильностью):
# echo 'options i915 enable_guc=2' > /etc/modprobe.d/i915.conf
# echo 'options i915 fastboot=1' >> /etc/modprobe.d/i915.conf

# Б. Настройка VA-API (обычно определяется автоматически):
#   - Для новых GPU (Gen8+):
#     echo 'LIBVA_DRIVER_NAME=iHD' >> /etc/environment
#   - Для старых GPU:
#     echo 'LIBVA_DRIVER_NAME=i965' >> /etc/environment

# ЗАВЕРШЕНИЕ (для этого варианта):
# grub-mkconfig -o /boot/grub/grub.cfg
# mkinitcpio -P
# # (Не забудьте выполнить остальные шаги основного макета)


##############################################################
### ВАРИАНТ 2: AMD Radeon Graphics (Только AMD)
##############################################################
# БАЗОВАЯ УСТАНОВКА:
# pacman -S --noconfirm mesa vulkan-radeon libva-mesa-driver
# pacman -S --noconfirm lib32-mesa lib32-vulkan-radeon

# ОПЦИОНАЛЬНЫЕ НАСТРОЙКИ (в chroot или после):
# А. Настройки энергопотребления (обычно не требуются):
# echo 'options amdgpu dpm=1' > /etc/modprobe.d/amdgpu.conf
# echo 'options amdgpu ppfeaturemask=0xffffffff' >> /etc/modprobe.d/amdgpu.conf

# ЗАВЕРШЕНИЕ (для этого варианта):
# grub-mkconfig -o /boot/grub/grub.cfg
# mkinitcpio -P
# # (Не забудьте выполнить остальные шаги основного макета)


##############################################################
### ВАРИАНТ 3: NVIDIA Graphics (Проприетарные драйверы)
### Подходит для современных карт (Pascal, Turing, Ampere, Ada Lovelace и новее).
### Проверьте совместимость вашей конкретной модели.
##############################################################
# ==============================================
# ШАГ 1: ВЫБЕРИТЕ ДРАЙВЕР (в chroot). Установите ТОЛЬКО ОДИН:
# A. Для стандартного ядра (linux):
#    pacman -S --noconfirm nvidia nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia libva-nvidia-driver
# B. Для LTS-ядра (linux-lts):
#    pacman -S --noconfirm nvidia-lts nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia libva-nvidia-driver
# C. Универсальный DKMS-драйвер (если стандартный не подходит или кастомное ядро):
#    pacman -S --noconfirm nvidia-dkms nvidia-utils nvidia-settings lib32-nvidia-utils opencl-nvidia lib32-opencl-nvidia libva-nvidia-driver
# ==============================================

# ШАГ 2: ДОПОЛНИТЕЛЬНО (только для гибридной графики Intel/AMD + NVIDIA в chroot):
# Устанавливаем switcherooctl для управления GPU через D-Bus.
# Это современная альтернатива для запуска приложений на дискретной GPU.
# Работает как на ноутбуках, так и на некоторых настольных системах с поддержкой DCC.
# pacman -S --noconfirm switcheroo-control # Устанавливаем пакет (клиент и сервис)
# systemctl enable switcheroo-control.service # Включаем сервис
# ==============================================

# ШАГ 3: КОНФИГУРАЦИЯ СИСТЕМЫ (в chroot):
# Создание файла настройки модуля:
# echo 'options nvidia-drm modeset=1' > /etc/modprobe.d/nvidia.conf
# # echo 'options nvidia NVreg_DynamicPowerManagement=0x02' >> /etc/modprobe.d/nvidia.conf # Для ноутбуков (опционально)
# echo 'nvidia-drm' > /etc/modules-load.d/nvidia-drm.conf

# Настройка переменных окружения для совместимости (например, для DRI_PRIME или legacy приложений) в /etc/environment:
# echo -e '__NV_PRIME_RENDER_OFFLOAD=1\n__VK_LAYER_NV_optimus=NVIDIA_only' >> /etc/environment
# # Переменные выше могут быть полезны, но основной способ запуска на NVIDIA - это switcherooctl launch.
# ==============================================

# ШАГ 4: НАСТРОЙКА INITRAMFS (mkinitcpio) (в chroot):
# Обычно не требуется вручную добавлять модули NVIDIA в MODULES=().
# mkinitcpio сам находит их, если установлены драйверы.
# Если возникают ошибки загрузки, можно вручную добавить:
# # sed -i '/^MODULES=/ s/)/ nvidia nvidia_modeset nvidia_uvm nvidia_drm)/' /etc/mkinitcpio.conf
# ==============================================

# ШАГ 5: НАСТРОЙКА ГИБЕРНАЦИИ (в chroot):
# Убедитесь, что в GRUB_CMDLINE_LINUX_DEFAULT есть 'resume=UUID=...' (см. fstab) (Только при установке в BIOS).
# Убедитесь, что 'resume' есть в HOOKS mkinitcpio.conf (Только при установке в BIOS).
# ==============================================

# ШАГ 6: ФИНАЛЬНАЯ СБОРКА (в chroot):
# grub-mkconfig -o /boot/grub/grub.cfg
# mkinitcpio -P
# ==============================================


##############################################################
### ВАРИАНТ 4: NVIDIA Graphics (Старые карты, использующие драйвер nouveau)
### Подходит для старых дискретных карт (Fermi, Kepler, Maxwell 1st gen и др., например GT 740M),
### работающих в связке с интегрированной Intel/AMD (гибридная графика).
### ПРИМЕЧАНИЕ: Использует open-source драйвер nouveau.
### Не обеспечивает полную функциональность (CUDA, полноценный VAAPI через nvidia-vaapi).
### Основная цель - возможность переключения и использования через switcherooctl.
### !!! ВАЖНО: Перед выполнением установите пакеты из Варианта 1 (Intel) или Варианта 2 (AMD) !!!
### Это обеспечит работу основного дисплея и общие библиотеки (mesa, vulkan, va-api).
##############################################################
# ==============================================
# ШАГ 1: УСТАНОВКА ПАКЕТОВ, ПОДДЕРЖИВАЮЩИХ NOUVEAU (в chroot).
# Эти пакеты обеспечивают поддержку VA-API и 3D-ускорения для nouveau через Mesa.
# Убедитесь, что вы выполнили ШАГ 1 из Варианта 1 или 2 (установка mesa, vulkan и т.д.).
# pacman -S --noconfirm libva-mesa-driver
# # (Пакет lib32-mesa, установленный в Шаге 1 Варианта 1/2, обеспечивает 32-битную поддержку).
# ==============================================

# ==============================================
# ШАГ 2: ДОПОЛНИТЕЛЬНО (только для гибридной графики Intel/AMD + NVIDIA nouveau в chroot):
# Устанавливаем switcherooctl для управления GPU через D-Bus.
# pacman -S --noconfirm switcheroo-control # Устанавливаем пакет (клиент и сервис)
# systemctl enable switcheroo-control.service # Включаем сервис
# ==============================================

# ==============================================
# ШАГ 3: (Опционально) НАСТРОЙКА nouveau (в chroot).
# Создание файла modprobe для задания параметров nouveau (редко требуется).
# echo 'options nouveau modeset=1' > /etc/modprobe.d/nouveau.conf
# ==============================================

# ==============================================
# ШАГ 4: ФИНАЛЬНАЯ СБОРКА (в chroot).
# Выполните команды, как в других вариантах:
# grub-mkconfig -o /boot/grub/grub.cfg
# mkinitcpio -P
# ==============================================


# 5. ОПЦИОНАЛЬНЫЕ НАСТРОЙКИ ДЛЯ НОУТБУКОВ (в chroot - после установки драйверов, до DE/WM)
# ============================================================== 
# Выполните этот раздел *внутри chroot*, *после* установки драйверов и финальной сборки (grub-mkconfig, mkinitcpio),
# но *перед* установкой DE/WM.
# ==============================================================

# # А. Управление питанием (TLP - популярный выбор):
# pacman -S --noconfirm tlp tlp-rdw
# systemctl enable tlp.service
# systemctl mask systemd-rfkill.service systemd-rfkill.socket

# # Б. Оптимизация энергопотребления:
# echo 'vm.swappiness=10' > /etc/sysctl.d/99-swappiness.conf
# systemctl enable fstrim.timer # Для SSD

# # Настройки завершены. Теперь вернитесь к основному макету и продолжайте установку DE/WM.


# 2. ВАЖНО: ВОЗВРАТ К ОСНОВНОМУ МАКЕТУ
# После выполнения команд выбранного варианта (в chroot), включая финальную сборку (grub-mkconfig, mkinitcpio):
# 1. Убедитесь, что все шаги из руководства выполнены *внутри chroot*.
# 2. НЕ ВЫХОДИТЕ из chroot.
# 3. ВЕРНИТЕСЬ к основному макету.
# 4. ПРОЧИТАЙТЕ РАЗДЕЛ "ОПЦИОНАЛЬНЫЕ НАСТРОЙКИ ДЛЯ НОУТБУКОВ" (см. ниже) и выполните его *в chroot*.
# 5. Продолжайте выполнение основного макета: выберите и выполните команды для установки
#    нужной вам графической среды (DE/WM) - это БЛОКИ 14-... внутри *той же* chroot-сессии.
# 6. После завершения установки DE/WM *внутри chroot*, ВЕРНИТЕСЬ К ЭТОМУ РУКОВОДСТВУ.
# 7. ПРОЧИТАЙТЕ и ВЫПОЛНИТЕ РАЗДЕЛ "ВИЗУАЛЬНЫЕ ТЕСТЫ" (см. ниже).
# 8. Затем выполните команду 'exit' в chroot.
# 9. Теперь продолжайте основной макет: выполните размонтирование и выключение.
# 10. После перезагрузки вернитесь к ЭТОМУ файлу для проверок.


#6. ПРОВЕРКА РАБОТЫ ВИДЕОКАРТ ПОСЛЕ ПЕРЕЗАГРУЗКИ

# ВЫПОЛНИТЕ ЭТИ КОМАНДЫ ТОЛЬКО ПОСЛЕ ПЕРЕЗАГРУЗКИ В НОВУЮ СИСТЕМУ И ВХОДА КАК ПОЛЬЗОВАТЕЛЬ!
# Убедитесь, что пакеты для проверки установлены (они входят в основной макет или должны быть установлены дополнительно).

# Проверка драйвера NVIDIA (только для проприетарных драйверов):
# nvidia-smi

# Проверка Vulkan (для всех):
# vulkaninfo --summary

# Проверка VA-API (для всех):
# vainfo

# Проверка switcherooctl (для гибридной графики):
# switcherooctl list # Проверяем, видит ли утилита обе карты
# switcherooctl launch --gpu 1 glxinfo | grep 'OpenGL renderer string' # Запускаем glxinfo через switcherooctl на GPU 1 (NVIDIA - проприетарный или nouveau)

# Проверка Prime Offloading (Xorg, Legacy, если переменные окружения заданы) (только для NVIDIA с проприетарными драйверами):
# __NV_PRIME_RENDER_OFFLOAD=1 __GLX_VENDOR_LIBRARY_NAME=nvidia glxinfo | grep 'OpenGL renderer string'


# ВИЗУАЛЬНЫЕ ТЕСТЫ

# pacman -S --noconfirm mesa-utils vulkan-tools glmark2 mesa-demos
# # glmark2 - более сложный OpenGL бенчмарк

# # 1. Откройте терминал в графической оболочке.
# # 2. Выполните команды для проверки:

# #    - glxgears (должны вращаться шестерёнки)
# #    - vkcube (должен вращаться 3D куб)
# #    - glmark2 (запустит бенчмарк OpenGL)
# #    - glxinfo | grep 'renderer string' (проверка драйвера)
# #    - Для NVIDIA с switcherooctl: switcherooctl launch --gpu 1 glmark2
# #    - Для NVIDIA с legacy Prime: DRI_PRIME=1 vkcube или DRI_PRIME=1 glmark2
# # Если изображение появляется и анимируется, драйвер работает корректно!


# 7. ИСПОЛЬЗОВАНИЕ switcherooctl (после установки системы и входа в сеанс пользователя)
# ============================================================== 
# После перезагрузки и входа в систему, вы можете использовать switcherooctl для запуска приложений на определённой видеокарте.
# ==============================================================

# # А. Определение ID видеокарты:
# # Перед запуском приложения узнайте ID интересующей вас видеокарты.
# switcherooctl list
# # В выводе будет список устройств (Device: 0, Device: 1 и т.д.). Найдите вашу дискретную карту (например, NVIDIA) и запомните её номер (Device: X).
# # В примере выше, NVIDIA - это Device: 1.

# # Б. Запуск приложения на определённой видеокарте:
# # Используйте команду switcherooctl launch --gpu <ID> <команда>.
# # Примеры:
# # Запуск игры (например, steam) на дискретной GPU (предположим, ID = 1):
# switcherooctl launch --gpu 1 steam
# # Запуск glxinfo для проверки OpenGL рендера:
# switcherooctl launch --gpu 1 glxinfo | grep "OpenGL renderer string"
# # Запуск vkcube для проверки Vulkan:
# switcherooctl launch --gpu 1 vkcube
# # Запуск бенчмарка:
# switcherooctl launch --gpu 1 glmark2

# # В. Интеграция с графическими оболочками:
# # 1. KDE Plasma: В настоящее время (на момент составления) прямой интеграции в меню запуска приложений через щелчок правой кнопкой мыши через switcherooctl нет.
# #    Вы можете создать собственный .desktop файл, который будет вызывать switcherooctl launch --gpu X %U (где X - ID GPU, %U - передача аргументов).
# # 2. GNOME: Обычно предоставляет интеграцию через контекстное меню. Щёлкните правой кнопкой мыши по ярлыку приложения (например, в меню приложений или на рабочем столе).
# #    Должна появиться опция вроде "Запустить на дискретной видеокарте" ("Run with Dedicated Graphics") или аналогичная. Выбор этой опции эквивалентен запуску через switcherooctl launch.
# # 3. Xfce, LXDE и другие: Обычно отсутствует. Используйте терминал или создайте .desktop файл.
# # 4. Общее решение: Для удобства можно создать ярлыки или скрипты, оборачивающие вызовы switcherooctl launch.
# ==============================================================
